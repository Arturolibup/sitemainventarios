<div class="p-6">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold text-primary mb-0">
      <i class="fas fa-star text-warning me-2"></i> Productos Prioritarios IA
    </h4>
    <button class="btn btn-outline-primary btn-sm"
        [disabled]="!selectedProduct"
        (click)="openAnalysisModal(selectedProduct)">
  <i class="fas fa-lightbulb me-2"></i> Análisis IA / Exportar PDF
</button>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="text-center py-10">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 text-muted">Analizando productos...</p>
  </div>

  <!-- LISTA -->
  <div *ngIf="!loading && products.length" class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light fw-bold text-muted">
        <tr>
          <th class="text-center" style="width:5%">#</th>
          <th style="width:25%">Producto</th>
          <th style="width:20%">Categoría</th>
          <th class="text-center" style="width:10%">Stock</th>
          <th class="text-center" style="width:10%">Umbral</th>
          <th class="text-center" style="width:10%">Nivel</th>
          <th style="width:20%">Alerta / Recomendación</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of products; let i = index" (click)="selectProduct(p)" class="cursor-pointer">
          <td class="text-center fw-bold">{{ i + 1 }}</td>
          <td class="fw-semibold text-dark">{{ p.title }}</td>
          <td>{{ p.category || p.categoria || '—' }}</td>
          <td class="text-center fw-bold" [ngClass]="{
              'text-danger': p.stock_actual < p.umbral,
              'text-warning': p.stock_actual < (p.umbral * 1.5) && p.stock_actual >= p.umbral,
              'text-success': p.stock_actual >= (p.umbral * 1.5)
            }">
            {{ p.stock_actual | number }}
          </td>
          <td class="text-center text-muted">{{ p.umbral | number }}</td>
          <td class="text-center">
            <span [ngClass]="getSeverityBadge(p.severity)">{{ getSeverityText(p.severity) }}</span>
          </td>
          <td class="text-muted small">{{ p.alert || '—' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- SIN RESULTADOS -->
  <div *ngIf="!loading && !products.length" class="text-center text-muted py-10">
    <i class="fas fa-circle-check fs-1 text-success mb-2"></i>
    <p class="fw-semibold">Sin productos prioritarios detectados por la IA.</p>
  </div>

  <!-- DETALLE DE PRODUCTO -->
  <div *ngIf="selectedProduct" class="mt-8 card shadow-sm border-0 rounded-3 animate__animated animate__fadeIn">
    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-bold text-primary">
        <i class="fas fa-chart-line me-2"></i> {{ selectedProduct.title }}
      </h5>
      <button class="btn btn-sm btn-light-danger" (click)="selectedProduct = null">
        <i class="fas fa-times me-1"></i> Cerrar
      </button>
    </div>
    <div class="card-body p-4">
      <canvas id="productChart" height="220"></canvas>
      <div class="mt-4">
        <p class="text-muted mb-1">
          <strong>Recomendación IA:</strong> {{ selectedProduct.alert }}
        </p>
        <p class="small text-muted">
          Nivel:
          <span [ngClass]="getSeverityBadge(selectedProduct.severity)">
            {{ getSeverityText(selectedProduct.severity) }}
          </span>
          · Precisión: {{ (selectedProduct.confidence * 100) | number:'1.0-1' }}%
        </p>
      </div>
    </div>
  </div>
</div>

<style>
  .table tr:hover { background-color: #f8fafc !important; }
  .cursor-pointer { cursor: pointer; }
  .badge { border-radius: 0.5rem; font-weight: 600; padding: 0.35em 0.6em; }
</style>
