<div class="card shadow-sm" *ngIf="authService.hasRole(['Super-Admin', 'Almacen'])" >
  <!-- ðŸ”¹ ENCABEZADO -->
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h3 class="mb-0">ðŸ“‹ Crear o editar convocatoria de requisiciÃ³n</h3>
    <div class="d-flex">
      <button class="btn btn-sm btn-outline-secondary me-2" (click)="goBack()">
        <i class="fa fa-arrow-left me-1"></i> Salir
      </button>
      <button class="btn btn-sm btn-primary" (click)="save()" [disabled]="loading">
        <i class="fa fa-save me-1"></i>
        {{ loading ? 'Guardando...' : 'Guardar convocatoria' }}
      </button>
    </div>
  </div>

  <div class="card-body">
    <!-- ðŸ§¾ FORMULARIO PRINCIPAL -->
    <form [formGroup]="form" class="row g-3">
      <div class="col-md-6">
        <label class="form-label fw-bold">TÃ­tulo de la convocatoria</label>
        <input
          type="text"
          class="form-control text-uppercase"
          formControlName="title"
          placeholder="Ej. REQUISICIÃ“N OCTUBRE 2025"
        />
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">AÃ±o</label>
        <input
          type="number"
          class="form-control"
          formControlName="year"
          min="2024"
          max="2100"
        />
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">Mes</label>
        <select class="form-select" formControlName="month">
          <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">
            {{ getMonthName(m) }}
          </option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold">Fecha de apertura</label>
        <input
          type="date"
          class="form-control"
          formControlName="open_at"
          (change)="validateDateWindow()"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label fw-bold">Fecha de cierre</label>
        <input
          type="date"
          class="form-control"
          formControlName="close_at"
          (change)="validateDateWindow()"
        />
      </div>

      <div class="col-md-12 mt-2 text-end">
        <small
          *ngIf="dateDiffDays !== null"
          [ngClass]="{
            'text-danger': dateDiffDays > 10,
            'text-success': dateDiffDays <= 10
          }"
        >
          <i class="fa fa-calendar-day me-1"></i>
          Ventana seleccionada:
          <b>{{ dateDiffDays }}</b> dÃ­a{{ dateDiffDays === 1 ? '' : 's' }}
          (mÃ¡x. 10)
        </small>
      </div>

      <div class="col-md-12 form-check form-switch mt-3">
        <input
          class="form-check-input"
          type="checkbox"
          role="switch"
          formControlName="is_active"
          id="activeSwitch"
        />
        <label class="form-check-label fw-bold ms-2" for="activeSwitch">
          Convocatoria activa
        </label>
      </div>
    </form>

    <hr class="my-4" />

    <!-- ðŸ” BUSCADOR DE PRODUCTOS -->
    <div class="mb-3">
      <label class="form-label fw-bold">Buscar productos por nombre o clave</label>
      <input
        type="text"
        class="form-control text-uppercase"
        placeholder="Ej. PAPEL BOND, PLUMA, CARPETA..."
        [formControl]="searchControl"
        [disabled]="searching || loading"
      />

      <div *ngIf="searching" class="text-muted small mt-1">
        <i class="fa fa-spinner fa-spin me-1"></i>Buscando productos...
      </div>

      <!-- ðŸ”½ LISTA DE RESULTADOS -->
<div *ngIf="!searching && results.length > 0" 
     class="list-group mt-2 shadow-sm" 
     style="max-height: 300px; overflow-y: auto;">
  <button
    *ngFor="let p of results"
    type="button"
    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
    (click)="addProduct(p, $event)"
    style="cursor: pointer;"
  >
    <div>
      <b>{{ p.title || 'Sin nombre' }}</b>
      <div class="small text-muted">
        CÃ³digo: {{ p.sku || 'â€”' }} |
        Unidad: {{ p.unit || 'â€”' }} |
        Stock: {{ p.stock }}
      </div>
    </div>
    <i class="fa fa-plus text-success"></i>
  </button>
</div>

      <div
        *ngIf="!searching && searchControl.value && results.length === 0"
        class="text-muted small mt-1"
      >
        <i class="fa fa-info-circle me-1"></i>Sin resultados.
      </div>
    </div>

    <!-- ðŸ§® TABLA DE PRODUCTOS SELECCIONADOS -->
    <div *ngIf="selectedProducts.length > 0" class="mt-4">
      <h5 class="fw-bold mb-2 text-primary">
        ðŸ“¦ Productos seleccionados ({{ selectedProducts.length }})
      </h5>

      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Producto</th>
              <th>CÃ³digo</th>
              <th>Unidad</th>
              <th>Stock</th>
              <th>Cantidad</th>
              <th>AcciÃ³n</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of selectedProducts; let i = index">
              <td>{{ i + 1 }}</td>
              <td class="text-start">{{ p.title }}</td>
              <td>{{ p.sku || 'â€”' }}</td>
              <td>{{ p.unit || 'â€”' }}</td>
              <td>{{ p.stock || 0 }}</td>
              <td style="width: 110px">
                <input
                  type="number"
                  disabled=""
                  class="form-control form-control-sm text-center"
                  [(ngModel)]="p.quantity"
                  [ngModelOptions]="{standalone:true}"
                  min="1"
                />
              </td>
              <td>
                <button class="btn btn-sm btn-outline-danger" (click)="removeProduct(i)">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ðŸ”˜ BOTONES FINALES -->
    <div class="d-flex justify-content-end mt-4 gap-2">
      <button class="btn btn-outline-secondary" (click)="goBack()">
        <i class="fa fa-arrow-left me-1"></i> Salir
      </button>
      <button *ngIf = "authService.hasRole(['Almacen'])" 
        class="btn btn-primary" (click)="save()" [disabled]="loading">
        <i class="fa fa-save me-1"></i>
        {{ loading ? 'Guardando...' : 'Guardar convocatoria' }}
      </button>
    </div>
  </div>
</div>
