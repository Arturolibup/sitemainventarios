<div class="card shadow-sm p-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <h4 class="fw-bold text-primary m-0">ğŸ“‹ Mis requisiciones
    <button class="btn btn-outline-primary me-2" routerLink="/dashboard">
        <i class="fa fa-home me-2"></i>MenÃº Principal
      </button>
    </h4>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <!-- Filtro AÃ±o -->
      <select class="form-select form-select-sm" style="width: 120px" [(ngModel)]="selectedYear" (change)="loadRequisitions()">
        <option [ngValue]="null">AÃ±o</option>
        <option *ngFor="let y of [2024, 2025, 2026, 2027]" [ngValue]="y">{{ y }}</option>
      </select>

      <!-- Filtro Mes -->
      <select class="form-select form-select-sm" style="width: 140px" [(ngModel)]="selectedMonth" (change)="loadRequisitions()">
        <option [ngValue]="null">Mes</option>
        <option *ngFor="let m of ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']; let i = index" [ngValue]="i+1">{{ m }}</option>
      </select>

      <!-- Buscar -->
      <div class="input-group input-group-sm" style="width: 360px">
        <span class="input-group-text">ğŸ”</span>
        <input type="text" class="form-control" placeholder="buscar...." 
        (input)="onSearchInput($event)" 
        #searchInput/>
      </div>
      <button 
    class="btn btn-outline-secondary" 
    type="button" 
    (click)="clearSearch()"
    title="Limpiar bÃºsqueda"
  >
    Limpiar busqueda âœ•
  </button>

      <!-- Crear nueva -->
    </div>
  </div>

  <!-- ğŸ”¹ Convocatorias activas -->
  <div *ngIf="activeCalls.length > 0" class="mb-4">
    <h5 class="fw-bold text-success mb-3">ğŸ“¢ Convocatorias activas</h5>

    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr class="text-center">
            <th>No.</th>
            <th>TÃ­tulo</th>
            <th>Periodo</th>
            <th>Apertura</th>
            <th>Cierre</th>
            <th>AcciÃ³n</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of filteredActiveCalls">
            <td class="text-center">{{ c.id }}</td>
            <td class="text-center">{{ c.title }}</td>
            <td class="text-center">{{ c.month }}/{{ c.year }}</td>
            <td class="text-center">{{ c.open_at | date:'yyyy-MM-dd' }}</td>
            <td class="text-center">{{ c.close_at | date:'yyyy-MM-dd' }}</td>
            <td class="text-center">
  <button 
    *ngIf="hasBaseGeneral(c) && !hasParticipated(c)" 
    class="btn btn-sm btn-success" 
    (click)="participate(c)">
    Participar
  </button>
  <button 
    *ngIf="hasBaseGeneral(c) && hasParticipated(c)" 
    class="btn btn-sm btn-secondary" 
    disabled>
    Ya participaste
  </button>
  <button 
    *ngIf="!hasBaseGeneral(c)" 
    class="btn btn-sm btn-warning" 
    disabled>
    Esperar base general
  </button>
</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <ng-container *ngIf="!loading; else loadingTpl">
    <div *ngIf="filteredRequisitions.length === 0" class="text-center py-5">
      
      <h6 class="fw-semibold mb-2">Sin resultados</h6>
      <p class="text-muted mb-3">No encontramos requisiciones Anteriores.</p>
      <button class="btn btn-outline-primary btn-sm" 
      (click)="loadRequisitions()">Reintentar</button>
    </div>
    <!--si hay datos: pinta tabla-->
    <div *ngIf="filteredRequisitions.length > 0" class="table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead class="bg-light">
          <tr class="text-center">
            <th style="width: 90px;">#</th>
            <th>Convocatoria</th>
            <th>Ãrea</th>
            <th>SubÃ¡rea</th>
            <th style="width: 130px;">Estatus</th>
            <th style="width: 160px;">Solicitada</th>
            <th style="width: 200px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of filteredRequisitions">
            <td class="text-center fw-semibold">#{{ r?.id }}</td>
            <td>
              <div class="fw-semibold">{{ r?.call?.title || '-' }}</div>
              <div class="text-muted small">Periodo: {{ r?.call?.month }}/{{ r?.call?.year }}</div>
            </td>
            <td>{{ r?.area?.name || '-' }}</td>
            <td>{{ r?.subarea?.name || '-' }}</td>
            <td class="text-center">
              <span
                class="badge"
                [ngClass]="{
                  'bg-secondary': r?.status === 'draft',
                  'bg-info': r?.status === 'sent',
                  'bg-success': r?.status === 'approved || aprobada',
                  'bg-danger': r?.status === 'rejected'
                }"
              >
                {{ r?.status || '-' }}
              </span>
            </td>
            <td class="text-center">
              {{ r?.requested_at ? (r.requested_at | date:'yyyy-MM-dd HH:mm') : '-' }}
            </td>
            <td class="text-center">
  <div class="btn-group btn-group-sm" role="group">
    <button class="btn btn-light" (click)="viewDetail(r)" title="Detalle">Ver</button>

    <button 
      class="btn btn-warning" 
      (click)="editRequisition(r)" 
      [disabled]="r?.status !== 'draft'" 
      title="Editar borrador">
      Editar
    </button>

    <button 
      class="btn btn-success" 
      (click)="sendRequisition(r)" 
      [disabled]="r?.status !== 'draft'" 
      title="Enviar">
      Enviar
    </button>

    <!-- âœ… Mostrar PDF solo cuando ya hay vale firmado -->
    <button 
      *ngIf="r.exit_generated && r.exit_status === 'completed' && r.exit_pdf_url" 
      class="btn btn-info" 
      (click)="viewExitPdf(r.exit_pdf_url)" 
      title="Ver vale firmado">
      PDF
    </button>

    <!-- NUEVO: BotÃ³n Eliminar (solo si no tiene salida) -->
    <button 
      *ngIf="!r.exit_generated && r.status === 'draft'" 
      class="btn btn-danger" 
      (click)="deleteRequisition(r)" 
      title="Eliminar borrador">
      Eliminar
    </button>
  </div>
</td>
          </tr>
        </tbody>
      </table>
    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2 mb-0">Cargandoâ€¦</p>
    </div>
  </ng-template>
</div>
