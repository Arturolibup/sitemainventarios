<div class="container-fluid">
  <!-- Título y buscador -->
  <div class="row mb-3">
    <div class="col-12 col-md-6">
      <h2>Listado de Suficiencias Presupuestales y Órdenes de Pedido</h2>
    </div>
    <div class="col-12 col-md-6 text-end">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          placeholder="Buscar por proveedor, fecha, folio o número de orden"
          [ngModel]="searchQuery"
          (ngModelChange)="onSearchChange($event)"
        />
        <button class="btn btn-outline-secondary" type="button" (click)="resetSearch()">
          <i class="fas fa-times"></i> Limpiar
        </button>
      </div>
      <button
        class="btn btn-primary mt-2"
        (click)="navigateToCreate()"
        *ngIf="authService.hasPermission('orders.create_sf')"
      >
        <i class="fas fa-plus"></i> Nueva Suficiencia
      </button>
    </div>
  </div>

  <!-- Notificaciones globales -->
  <div class="notifications-container" *ngIf="notifications.length > 0">
    <div
  class="alert alert-dismissible fade show mb-2"
  *ngFor="let notification of notifications; trackBy: trackByNotification"
  [ngClass]="{
    'alert-info': notification.type === 'info',
    'alert-success': notification.type === 'success',
    'alert-danger': notification.type === 'error',
    'alert-warning': notification.type === 'warning'
  }"
>
  <strong>{{ notification.message }}</strong>

  <button
    type="button"
    class="close"
    (click)="dismissNotification(notification.id)"
  >
    <span>&times;</span>
  </button>
</div>

  </div>

  <!-- Tabla de órdenes -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="thead-dark">
        <tr>
          <th class="text-center align-middle bg-light">Folio SF</th>
          <th class="text-center align-middle bg-light">Número de Orden</th>
          <th class="text-center align-middle bg-light">Proveedor</th>
          <th class="text-center align-middle bg-light">Fecha</th>
          <th class="text-center align-middle bg-light">Estado</th>
          <th class="text-center align-middle bg-light">Fecha Límite</th>
          <th class="text-center align-middle bg-light">Entrega Almacen</th>
          <th class="text-center align-middle bg-light">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngIf="!isLoading; else loading">
          <tr *ngFor="let order of orders; trackBy: trackByOrder">
            <!-- Folio SF -->
            <td class="text-center">{{ order.foliosf || 'N/A' }}</td>

            <!-- Número de Orden -->
            <td class="text-center">
              <span class="text-muted" *ngIf="!order.order_number">Por asignar</span>
              <span *ngIf="order.order_number">{{ order.order_number }}</span>
            </td>

            <!-- Proveedor -->
            <td class="text-center">{{ order.provider?.full_name || 'N/A' }}</td>

            <!-- Fecha -->
            <td class="text-center">{{ order.created_at | date:'dd/MM/yyyy' }}</td>

            <!-- Estado -->
            <td class="text-center">
              <span
                class="badge"
                [ngClass]="{
                  'badge-warning': order.status === 'pending_sf_validation',
                  'badge-success': order.status === 'validate_sf',
                  'badge-info': order.status === 'pending_warehouse',
                  'badge-primary': order.status === 'partially_received',
                  'badge-alert': order.status === 'completed',
                  'badge-secondary': !order.status
                }"
              >
                {{ getStatusLabel(order.status) }}
              </span>
            </td>

            <!-- Notificaciones -->
            <td class="text-center">
              <ng-container *ngIf="order.date_limited; else noLimit">
                {{ order.date_limited | date:'dd/MM/yyyy' }}
              </ng-container>
              <ng-template #noLimit>—</ng-template>
            </td>
            <!-- Encabezado -->
            

            <!-- En cada fila -->
            <td class="text-center">
            <button type="button"
                    class="sem-btn-reset"
                    [title]="getReceiveTooltip(order)"
                    [attr.aria-label]="getReceiveTooltip(order)"
                    (click)="goToReceive(order)">
              <span class="sem-dot" [ngClass]="getReceiveDotClass(order)"></span>
            </button>
          </td>

            <!-- Acciones -->
            <td class="text-center">
              <div class="btn-group">
                <!-- Editar SF (Área 1) -->
                <button
                  class="btn btn-primary btn-sm"
                  *ngIf="canEdit(order)"
                  (click)="navigateToEdit(order.id)"
                  title="Editar"
                >
                  <i class="fas fa-edit"></i> Editar
                </button>

                <!-- Validar SF (Área 2 - Contabilidad) -->
                <button
                  class="btn btn-success btn-sm"
                  *ngIf="canValidate(order)"
                  (click)="navigateToValidate(order.id)"
                  title="Validar SF"
                >
                  <i class="fas fa-check"></i> Validar SF
                </button><button
                    class="btn btn-primary btn-sm"
                    *ngIf="canAddOrderNumber(order)"
                    (click)="navigateToAddOrderNumber(order.id)"
                    title="Asignar O.P"
                  >
                    <i class="fas fa-list"></i> Asignar O.P.
                  </button>



                <!-- Asignar Número de Orden (Área 1 - Operador) 
                <button
                  class="btn btn-success btn-sm"
                  *ngIf="canAssignOrderNumber(order)"
                  (click)="navigateToValidate(order.id)"
                  title="Asignar Número de Orden"
                >
                  <i class="fas fa-list-ol"></i> Asignar Nº Orden
                </button>-->

                <!-- Facturas -->
                <button
                  class="btn btn-warning btn-sm"
                  (click)="navigateToInvoices(order)"
                  title="Ver/Subir Facturas"
                >
                  <i class="fas fa-file-invoice"></i>
                  <span *ngIf="order.invoices_count && order.invoices_count > 0">
                    {{ order.invoices_count }}
                  </span>
                </button>

                <button
                  class="btn btn-danger btn-sm"
                  *ngIf="authService.hasPermission('orders.delete')"
                  (click)="deleteOrder(order)"
                  title="Eliminar orden o suficiencia"
                >
                  <i class="fas fa-trash"></i> 
                </button>

                <!-- Descargar PDF 
                <button
                  class="btn btn-secondary btn-sm"
                  *ngIf="canDownloadPdf(order)"
                  (click)="downloadPdf(order.id)"
                  title="Descargar PDF"
                >
                  <i class="fas fa-download"></i> PDF
                </button>

                Subir Factura 
                <button
                  class="btn btn-info btn-sm"
                  *ngIf="canUploadInvoice(order)"
                  (click)="uploadInvoice(order.id)"
                  title="Subir Factura"
                >
                  <i class="fas fa-upload"></i> Factura
                </button>-->
              </div>
            </td>
          </tr>

          <!-- Sin resultados -->
          <tr *ngIf="orders.length === 0">
            <td colspan="7" class="text-center">No se encontraron órdenes</td>
          </tr>
        </ng-container>

        <!-- Loader -->
        <ng-template #loading>
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-2 mb-0">Cargando órdenes...</p>
            </td>
          </tr>
        </ng-template>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <div
    class="d-flex justify-content-between align-items-center mt-3"
    *ngIf="totalItems > 0"
  >
    <div>
      Mostrando
      {{ (currentPage - 1) * itemsPerPage + 1 }}
      -
      {{ currentPage * itemsPerPage > totalItems ? totalItems : currentPage * itemsPerPage }}
      de {{ totalItems }} registros
    </div>
    <nav *ngIf="totalPages > 1">
      <ul class="pagination">
        <li class="page-item" [ngClass]="{ disabled: currentPage === 1 }">
          <button class="page-link" (click)="changePage(currentPage - 1)">Anterior</button>
        </li>

        <li
          class="page-item"
          *ngFor="let page of getPageNumbers(); trackBy: trackByPage"
          [ngClass]="{ active: page === currentPage, disabled: page === -1 }"
        >
          <button class="page-link" (click)="page !== -1 && changePage(page)">
            {{ page === -1 ? '...' : page }}
          </button>
        </li>

        <li class="page-item" [ngClass]="{ disabled: currentPage === totalPages }">
          <button class="page-link" (click)="changePage(currentPage + 1)">Siguiente</button>
        </li>
      </ul>
    </nav>
  </div>
</div>

