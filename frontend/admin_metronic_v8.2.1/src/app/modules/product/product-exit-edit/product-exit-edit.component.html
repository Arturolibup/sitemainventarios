<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
        <div id="kt_app_toolbar_container" class="app-container container-xxl d-flex flex-stack">
            <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
                <h1 class="page-heading d-flex text-gray-900 fw-bold fs-3 flex-column justify-content-center my-0">
                    Editar Salida de Productos
                </h1>
            </div>
        </div>
    </div>
    <!--end::Toolbar-->

    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-xxl">
            <form id="kt_product_form" class="form d-flex flex-column flex-lg-row gap-7" (ngSubmit)="saveExit(productForm)" #productForm="ngForm"> 
                <!-- Columna derecha principal -->
                <div class="d-flex flex-column flex-row-fluid gap-7">
                    <!-- Información General -->
                    <div class="card card-flush py-4">
                        <div class="card-header">
                            <h2 class="card-title fs-3">Información General</h2>
                        </div>
                        <div class="card-body pt-0">
                            <div class="row g-5 mb-8">
                                <div class="col-md-6">
                                    <label class="form-label required">Subárea:</label>
                                    <div *ngIf="searchSubareaResults.length > 0" class="search-results">
                                        <ul>
                                            <li *ngFor="let subarea of searchSubareaResults" (click)="selectSubarea(subarea)" class="list-group-item-action">
                                                {{ subarea.name }}
                                            </li>
                                        </ul>
                                    </div>
                                    <input type="text" [(ngModel)]="searchSubareaQuery" name="searchSubareaQuery" placeholder="Buscar subárea..." (input)="searchSubarea(searchSubareaQuery)" autocomplete="off" class="form-control" />
                                    <input type="text" [(ngModel)]="exitData.subarea_name" name="subarea_name" readonly required class="form-control" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label required">Área:</label>
                                    <input type="text" [(ngModel)]="exitData.area_name" name="area_name" readonly required class="form-control" />
                                </div>
                            </div>

                            <div class="row g-5 mb-8">
                                <div class="col-md-6">
                                    <label class="form-label required">Referencia:</label>
                                    <input type="text" [(ngModel)]="exitData.reference" name="reference" (input)="exitData.reference = exitData.reference.toUpperCase()" class="form-control" placeholder="Ingrese la referencia..." required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label required">Fecha de Salida:</label>
                                    <input type="date" [(ngModel)]="exitData.exit_date" name="exit_date" required class="form-control" />
                                </div>
                            </div>

                            <!-- Selección del modo de factura -->
                            <div class="row g-5 mb-8">
                                <div class="col-md-6">
                                    <label class="form-label required">Modo de Factura:</label>
                                    <select [(ngModel)]="exitData.invoice_mode" name="invoice_mode" (ngModelChange)="onInvoiceModeChange()" class="form-control" required>
                                        <option value="multiple_invoices">Varias Facturas</option>
                                        <option value="single_invoice">Una Sola Factura</option>
                                    </select>
                                </div>
                                <div class="col-md-6" *ngIf="exitData.invoice_mode === 'single_invoice'">
                                    <label class="form-label required">Factura:</label>
                                    <input type="text" [(ngModel)]="searchInvoiceQuery" name="searchInvoiceQuery" placeholder="Buscar factura..." (input)="searchInvoice(searchInvoiceQuery)" autocomplete="off" class="form-control" />
                                    <ul *ngIf="searchInvoiceResults.length > 0" class="search-results">
                                        <li *ngFor="let invoice of searchInvoiceResults" (click)="selectInvoice(invoice)" class="list-group-item-action">
                                            {{ invoice }}
                                        </li>
                                    </ul>
                                    <input type="text" [(ngModel)]="exitData.single_invoice_number" name="single_invoice_number" readonly class="form-control" />
                                </div>
                            </div>

                            <!-- Campos para estado visual y fecha de caducidad -->
                            <div class="row g-5 mb-8">
                                <div class="col-md-6">
                                    <label class="form-label required">Estado Visual:</label>
                                    <select [(ngModel)]="exitData.exit_status" name="exit_status" required class="form-control" (ngModelChange)="onStatusChange()">
                                        <option value="pending">Pendiente</option>
                                        <option value="completed">Completada</option>
                                    </select>
                                </div>
                                <div class="col-md-6" *ngIf="exitData.exit_status === 'pending'">
                                    <label class="form-label required">Fecha de Caducidad:</label>
                                    <input type="datetime-local" [(ngModel)]="exitData.pending_expires_at" name="pending_expires_at" required [min]="minDateTime" class="form-control" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Productos -->
                    <div class="card card-flush py-4">
                        <div class="card-header">
                            <h2 class="card-title fs-3">Productos</h2>
                        </div>
                        <div class="card-body pt-0">
                            <!-- Mostrar búsqueda manual solo en modo multiple_invoices -->
                            <div class="row g-5 mb-8" *ngIf="exitData.invoice_mode === 'multiple_invoices'">
                                <div class="col-md-12">
                                    <label class="form-label required">Buscar Producto:</label>
                                    <input type="text" [(ngModel)]="searchProductQuery" name="searchProductQuery" placeholder="Escribe para buscar..." (input)="searchProduct(searchProductQuery)" autocomplete="off" class="form-control" />
                                    <ul *ngIf="searchProductResults.length > 0" class="search-results">
                                        <li *ngFor="let product of searchProductResults" (click)="selectProduct(product)" class="list-group-item-action">
                                            {{ product.title }} ({{ product.unit }}) - Stock: {{ product.stock }}
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <div *ngIf="exitData.products.length === 0" class="alert alert-info">
                                No hay productos seleccionados. {{ exitData.invoice_mode === 'multiple_invoices' ? 'Busca y selecciona un producto para agregar.' : 'Selecciona una factura para cargar los productos.' }}
                            </div>

                            <!-- Tabla para modo "Una Sola Factura" -->
                            <div *ngIf="exitData.products.length > 0 && exitData.invoice_mode === 'single_invoice'">
                                <table class="table table-bordered text-center">
                                    <thead>
                                        <tr class="text-center">
                                            <th class="text-center">Producto</th>
                                            <th class="text-center">Stock de Factura</th>
                                            <th class="text-center">Cantidad</th>
                                            <th class="text-center">Facturas Utilizadas</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let product of exitData.products; let i = index" class="text-center">
                                            <td class="text-start">{{ product.title }} ({{ product.unit }})</td>
                                            <td class="text-center" [ngClass]="{'text-danger': product.stock < 5}">{{ formatStock(product.stock) }}</td>
                                            <td class="text-center">
                                                <input type="number" class="text-center" [(ngModel)]="product.quantity" [name]="'quantity_' + i" min="0" [max]="product.stock" (ngModelChange)="onQuantityChange(product, i)" class="form-control form-control-sm text-center" />
                                            </td>
                                            <td class="text-center">{{ getUsedEntriesDisplay(product) }}</td>
                                            <td class="d-flex justify-content-center align-items-center">
                                                <button type="button" (click)="removeProduct(i)" class="btn btn-danger btn-sm">Eliminar</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Tabla para modo "Varias Facturas" -->
                            <div *ngIf="exitData.products.length > 0 && exitData.invoice_mode === 'multiple_invoices'">
                                <table class="table table-bordered text-center">
                                    <thead>
                                        <tr class="text-center">
                                            <th class="text-center">Producto</th>
                                            <th class="text-center">Stock Disponible (Entrada)</th>
                                            <th class="text-center">Salida</th>
                                            <th class="text-center">Cantidad</th>
                                            <th class="text-center">Facturas Utilizadas</th>
                                            <th class="text-center">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let product of exitData.products; let i = index" class="text-center">
                                            <td class="text-start">{{ product.title }} ({{ product.unit }})</td>
                                            <td class="text-center" [ngClass]="{'text-danger': product.stock < 5}">{{ formatStock(product.stock) }}</td>
                                            <td class="text-center">{{ formatStock(product.original_quantity) }}</td>
                                            <td class="text-center">
                                                <input type="number" class="text-center" [(ngModel)]="product.quantity" [name]="'quantity_' + i" min="1" [max]="product.stock" required (ngModelChange)="onQuantityChange(product, i)" class="form-control form-control-sm text-center" />
                                            </td>
                                            <td class="text-center">{{ getUsedEntriesDisplay(product) }}</td>
                                            <td class="d-flex justify-content-center align-items-center">
                                                <button type="button" (click)="removeProduct(i)" class="btn btn-danger btn-sm">Eliminar</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-end gap-3">
                        <button type="button" (click)="cancel()" class="btn btn-light">Cancelar</button>
                        <button type="submit" class="btn btn-primary" [disabled]="isSaveDisabled()">
                            <span class="spinner-border spinner-border-sm align-middle ms-2" *ngIf="isLoading"></span>
                            <span class="indicator-label">Actualizar Salida</span>
                            <span class="indicator-progress">
                                <span class="spinner-border spinner-border-sm"></span>
                            </span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>